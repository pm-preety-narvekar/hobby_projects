<script>

/* SCENE */

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

let renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* IMPORTANT: allow browser gestures */
renderer.domElement.style.touchAction = "auto";

let camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);

/* GOOD DEFAULT ZOOM LEVEL */
camera.position.set(0, 70, 140);
camera.lookAt(0, 0, 0);

/* CONTROLS (PROPER MOBILE CONFIG) */

let controls = new THREE.OrbitControls(camera, renderer.domElement);

controls.enableDamping = true;
controls.dampingFactor = 0.08;

controls.enableRotate = true;
controls.enableZoom = true;
controls.enablePan = true;

controls.minDistance = 60;
controls.maxDistance = 250;
controls.maxPolarAngle = Math.PI / 2.05;

controls.zoomSpeed = 1.2;
controls.rotateSpeed = 0.6;
controls.panSpeed = 0.6;

/* RESIZE FIX */

window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* RAYCASTER */

let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();

/* SAFE TAP HANDLER */

function handleTap(event) {

  // Prevent only when single tap (not pinch)
  if (event.touches && event.touches.length > 1) return;

  let rect = renderer.domElement.getBoundingClientRect();

  let clientX = event.touches ? event.touches[0].clientX : event.clientX;
  let clientY = event.touches ? event.touches[0].clientY : event.clientY;

  mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);

  let intersects = raycaster.intersectObjects(cakes, true);

  if (intersects.length > 0) {

    let obj = intersects[0].object;

    while (obj.parent && !cakes.includes(obj)) {
      obj = obj.parent;
    }

    burst(obj.position.x, 10, obj.position.z, 0xffff00);

    scene.remove(obj);
    cakes = cakes.filter(c => c !== obj);

    if (cakes.length === 0) {
      setTimeout(() => {
        document.getElementById("inviteScreen").style.display = "flex";
      }, 1000);
    }
  }
}

/* IMPORTANT: passive:false REQUIRED FOR MOBILE */

renderer.domElement.addEventListener("touchstart", handleTap, { passive: true });
renderer.domElement.addEventListener("click", handleTap);

/* ANIMATION LOOP */

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

animate();

</script>